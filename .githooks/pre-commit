#!/bin/bash
# Pre-commit hook: Detect local path dependencies in Cargo.lock
#
# Patched (local) packages lack a `source` field in Cargo.lock.
# This hook prevents accidentally committing a lockfile with local paths.

set -e

# Only check if Cargo.lock is staged
if ! git diff --cached --name-only | grep -q "^Cargo.lock$"; then
    exit 0
fi

# Known local packages that should NOT appear without a source field
LOCAL_PACKAGES=("teapot" "inferadb")

for pkg in "${LOCAL_PACKAGES[@]}"; do
    # Check if package exists without a source field (indicating local path)
    # Pattern: [[package]] followed by name = "pkg" with NO source = line before next [[package]]
    if awk -v pkg="$pkg" '
        /^\[\[package\]\]/ { in_block=1; has_source=0; is_target=0; next }
        in_block && /^name = "'"$pkg"'"/ { is_target=1; next }
        in_block && /^source = / { has_source=1; next }
        in_block && /^\[\[/ {
            if (is_target && !has_source) { exit 1 }
            in_block=1; has_source=0; is_target=0
        }
        END { if (is_target && !has_source) exit 1 }
    ' Cargo.lock; then
        continue
    else
        echo "ERROR: Cargo.lock contains local path for '$pkg'"
        echo ""
        echo "Your .cargo/config.toml patches are leaking into the lockfile."
        echo "To fix, temporarily remove .cargo/config.toml and run:"
        echo ""
        echo "    mv .cargo/config.toml .cargo/config.toml.bak"
        echo "    cargo update -p $pkg"
        echo "    mv .cargo/config.toml.bak .cargo/config.toml"
        echo ""
        exit 1
    fi
done

exit 0
